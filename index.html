<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forefront Integration</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b1120;
            color: #d1d5db;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1f2937, #111827);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-4xl mx-auto rounded-3xl shadow-2xl p-8 bg-gray-900 border border-gray-700 my-8">

        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-5xl font-extrabold text-white mb-2">Forefront Integration</h1>
            <p class="text-lg text-gray-400">AI Solutions for the Modern Creator</p>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content-container" class="flex flex-col items-center space-y-8">
            <!-- Content will be dynamically loaded here -->
        </div>
    </div>

    <!-- Firebase and Stripe SDKs -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Stripe SDK import
        import { loadStripe } from 'https://js.stripe.com/v3/';

        // Set log level for debugging
        setLogLevel('Debug');

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
            appId: "YOUR_FIREBASE_APP_ID"
        };

        // Initialize Firebase
        let app, auth, db, functions, stripe;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            functions = getFunctions(app);
            // Stripe public key
            stripe = await loadStripe('YOUR_STRIPE_PUBLIC_KEY');
        } catch (error) {
            console.error("Firebase or Stripe initialization failed: ", error);
            displayMessage("Error: Could not initialize the application. Please check your console for details.");
        }

        const contentContainer = document.getElementById('content-container');
        const __app_id = "default-app-id"; // Dummy value for local testing
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Conditional rendering for the UI
        function renderUI(user, userTier) {
            contentContainer.innerHTML = '';
            
            if (!user) {
                // Not signed in: show login page and pricing
                renderLoginAndPricing();
            } else {
                // Signed in: show agent pages based on tier
                renderAgentPages(user, userTier);
            }
        }

        // Display a simple message box (alternative to alert)
        function displayMessage(message, type = 'info') {
            const messageBox = document.createElement('div');
            messageBox.className = `p-4 mt-4 rounded-lg text-center ${type === 'error' ? 'bg-red-900 text-red-300' : 'bg-green-900 text-green-300'} transition-all duration-300`;
            messageBox.textContent = message;
            contentContainer.appendChild(messageBox);
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.remove(), 300);
            }, 5000);
        }

        // --- Auth Functions ---
        async function googleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                console.log("User signed in:", user);
                // After sign-in, check for user document in Firestore and create if it doesn't exist
                const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                if (!userDoc.exists()) {
                    await setDoc(userDocRef, {
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        tier: 'none', // Default tier
                        createdAt: new Date()
                    });
                }
            } catch (error) {
                console.error("Google Sign-In Error: ", error);
                displayMessage("Sign-in failed. Please try again.", 'error');
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                renderUI(null);
                displayMessage("You have been signed out.");
            } catch (error) {
                console.error("Sign out error:", error);
                displayMessage("An error occurred during sign out. Please try again.", 'error');
            }
        }

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in, listen to their Firestore document for tier changes
                const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
                onSnapshot(userDocRef, (docSnap) => {
                    const userData = docSnap.data();
                    const userTier = userData?.tier || 'none';
                    console.log(`User tier updated to: ${userTier}`);
                    renderUI(user, userTier);
                }, (error) => {
                    console.error("Error listening to user document:", error);
                    displayMessage("An error occurred. Please refresh the page.", 'error');
                });
            } else {
                // User is signed out
                renderUI(null);
            }
        });

        // --- UI Rendering Functions ---
        function renderLoginAndPricing() {
            contentContainer.innerHTML = `
                <div class="text-center mb-8">
                    <p class="text-gray-400 text-xl mb-6">
                        Unlock powerful AI agents to level up your career.
                    </p>
                    <button id="google-sign-in-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-all duration-300 flex items-center justify-center space-x-2 mx-auto">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zM8.33 16.5c-2.45-1.5-4.1-4.04-4.1-7.14V8.48c0-3.1 1.65-5.64 4.1-7.14L10 2.27 8.33 4c-1.25.75-2.1 1.95-2.1 3.38v2.24c0 1.43.85 2.63 2.1 3.38L10 15.73l-1.67-1.77zM10 2.27L8.33 4 10 5.73 11.67 4zM10 5.73L8.33 4 10 2.27zM11.67 4L10 5.73 8.33 4 10 2.27zM15.52 10l-1.77-1.67L12 10.22l1.75 1.75-1.75 1.75zM12 10.22l1.75-1.75L12 10.22zM15.52 10l-1.77-1.67L12 10.22z"></path>
                        </svg>
                        <span>Sign In with Google</span>
                    </button>
                </div>

                <div class="w-full">
                    <h2 class="text-3xl font-bold text-center mb-8 text-white">Choose Your Plan</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        ${renderTierCard('Beginner', 'Access to Agent 1', ['Access to Agent 1', 'Basic content generation', 'Community support'], 10, 'price_1Pz187JtQ3s0Xk7Q9qWnI1fQ')}
                        ${renderTierCard('Creator', 'Access to Agent 1 & 2', ['All Beginner features', 'Access to Agent 2', 'Advanced content tools', 'Priority support'], 30, 'price_1Pz1B5JtQ3s0Xk7QhWfI2sK3')}
                        ${renderTierCard('Pro', 'Access to All Agents', ['All Creator features', 'Access to Agent 3', 'Exclusive pro agents', 'Direct line to team'], 90, 'price_1Pz1B8JtQ3s0Xk7QhWfI2sK4')}
                    </div>
                </div>
            `;
            document.getElementById('google-sign-in-btn').addEventListener('click', googleSignIn);
            document.querySelectorAll('.subscribe-btn').forEach(button => {
                button.addEventListener('click', (e) => handleStripeCheckout(e.target.dataset.priceId));
            });
        }

        function renderTierCard(name, subtitle, features, price, priceId) {
            return `
                <div class="gradient-bg p-6 rounded-2xl shadow-lg border border-gray-700 transition-all duration-300 hover:scale-105">
                    <h3 class="text-2xl font-bold text-white mb-2">${name}</h3>
                    <p class="text-sm text-gray-400 mb-4">${subtitle}</p>
                    <div class="mb-6 space-y-2">
                        ${features.map(feature => `<div class="flex items-center text-gray-300 text-sm">
                            <svg class="w-4 h-4 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span>${feature}</span>
                        </div>`).join('')}
                    </div>
                    <div class="text-center">
                        <p class="text-white text-3xl font-extrabold mb-4">$${price}<span class="text-sm text-gray-400 font-normal">/month</span></p>
                        <button class="subscribe-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 shadow-md" data-price-id="${priceId}">
                            Subscribe
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAgentPages(user, userTier) {
            contentContainer.innerHTML = `
                <div class="flex justify-between items-center w-full mb-8">
                    <div class="flex items-center space-x-4">
                        <img src="${user.photoURL || 'https://placehold.co/40x40/1f2937/d1d5db?text=User'}" alt="User Avatar" class="w-10 h-10 rounded-full border-2 border-blue-500">
                        <div>
                            <p class="text-white font-semibold">Welcome, ${user.displayName || 'Creator'}</p>
                            <p class="text-sm text-gray-400">Your tier: <span class="capitalize font-bold text-blue-400">${userTier}</span></p>
                            <p class="text-sm text-gray-400">Your User ID: ${user.uid}</p>
                        </div>
                    </div>
                    <button id="sign-out-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition-all duration-300 shadow-md">
                        Sign Out
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full">
                    <!-- Agent 1 Card (Accessible to everyone) -->
                    ${renderAgentCard('Agent 1', 'Beginner Content Generator', 'This agent helps you generate initial content ideas, headlines, and outlines.', 'bg-yellow-800')}
                    
                    <!-- Agent 2 Card (Creator and Pro only) -->
                    ${(userTier === 'creator' || userTier === 'pro') ? renderAgentCard('Agent 2', 'Creator Storyboard Assistant', 'This agent helps with advanced video storyboarding and script writing.', 'bg-purple-800') : `<div class="p-6 rounded-2xl bg-gray-800 border border-gray-700 transition-all duration-300 hover:scale-105">
                        <h3 class="text-2xl font-bold text-gray-600 mb-2">Agent 2</h3>
                        <p class="text-sm text-gray-500">Upgrade to Creator or Pro to unlock this agent.</p>
                    </div>`}

                    <!-- Agent 3 Card (Pro only) -->
                    ${userTier === 'pro' ? renderAgentCard('Agent 3', 'Pro Marketing Strategist', 'This agent provides data-driven marketing insights for social media campaigns.', 'bg-cyan-800') : `<div class="p-6 rounded-2xl bg-gray-800 border border-gray-700 transition-all duration-300 hover:scale-105">
                        <h3 class="text-2xl font-bold text-gray-600 mb-2">Agent 3</h3>
                        <p class="text-sm text-gray-500">Upgrade to Pro to unlock this agent.</p>
                    </div>`}
                </div>
            `;
            document.getElementById('sign-out-btn').addEventListener('click', handleSignOut);
        }

        function renderAgentCard(name, subtitle, description, bgColor) {
            return `
                <div class="p-6 rounded-2xl ${bgColor} border border-gray-700 transition-all duration-300 hover:scale-105">
                    <h3 class="text-2xl font-bold text-white mb-2">${name}</h3>
                    <p class="text-sm text-gray-300 mb-4">${subtitle}</p>
                    <p class="text-gray-400 mb-4 text-sm">${description}</p>
                    <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl transition-all duration-300 shadow-md">
                        Access Agent
                    </button>
                </div>
            `;
        }
        
        // --- Stripe Checkout Function ---
        async function handleStripeCheckout(priceId) {
            const createStripeCheckoutSession = httpsCallable(functions, 'createStripeCheckoutSession');

            try {
                // Call the Cloud Function to create a checkout session
                const { data: { sessionId } } = await createStripeCheckoutSession({ priceId });
                console.log("Stripe session ID received:", sessionId);

                // Redirect to Stripe's hosted payment page
                const result = await stripe.redirectToCheckout({ sessionId });

                if (result.error) {
                    console.error("Stripe redirection error:", result.error.message);
                    displayMessage("An error occurred during payment. Please try again.", 'error');
                }
            } catch (error) {
                console.error("Error creating Stripe checkout session:", error);
                displayMessage("Failed to initiate payment. Please try again.", 'error');
            }
        }

    </script>

</body>
</html>

